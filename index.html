<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è Database Readiness Checker - SMAN 2 Cikarang Barat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #8b5cf6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            color: #6b7280;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .worker-url {
            background: #f1f5f9;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: inline-block;
            font-family: 'Courier New', monospace;
            color: var(--primary);
            border: 1px dashed var(--primary);
        }
        
        /* Status Cards */
        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .card-icon.connection { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-icon.performance { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-icon.data { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-icon.security { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .card-subtitle {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .status-ready {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-loading {
            background: rgba(37, 99, 235, 0.15);
            color: var(--primary);
            border: 1px solid rgba(37, 99, 235, 0.3);
        }
        
        /* Progress Bars */
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #4b5563;
        }
        
        .progress-bar {
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .progress-success { background: linear-gradient(90deg, #10b981, #34d399); }
        .progress-warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .progress-error { background: linear-gradient(90deg, #ef4444, #f87171); }
        .progress-info { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .metric-value.success { color: var(--success); }
        .metric-value.warning { color: var(--warning); }
        .metric-value.danger { color: var(--danger); }
        .metric-value.info { color: var(--info); }
        
        /* Details Panel */
        .details-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 40px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        
        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .details-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        
        .log-entry {
            padding: 15px;
            margin-bottom: 10px;
            background: #f9fafb;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-success { border-left-color: var(--success); }
        .log-warning { border-left-color: var(--warning); }
        .log-error { border-left-color: var(--danger); }
        .log-info { border-left-color: var(--info); }
        
        /* Controls */
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #1d4ed8);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: #4b5563;
            border: 2px solid #e5e7eb;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: var(--primary);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .status-cards {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
            }
        }
        
        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>
                <i class="fas fa-database"></i>
                Database Readiness Checker
            </h1>
            <p>Comprehensive health check for NocoDB database and Cloudflare Worker</p>
            <div class="worker-url">
                <i class="fas fa-server"></i>
                Worker: nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev
            </div>
        </header>

        <!-- Status Cards -->
        <div class="status-cards">
            <!-- Connection Status -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon connection">
                        <i class="fas fa-plug"></i>
                    </div>
                    <div>
                        <div class="card-title">Connection Status</div>
                        <div class="card-subtitle">Cloudflare Worker & NocoDB API</div>
                    </div>
                </div>
                <div id="connection-status" class="status-indicator status-loading">
                    <i class="fas fa-sync-alt spin"></i>
                    <span>Testing connections...</span>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Worker Connection</span>
                        <span id="worker-score">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="worker-progress" class="progress-fill progress-info" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>NocoDB API</span>
                        <span id="api-score">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="api-progress" class="progress-fill progress-info" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric">
                        <div id="latency-value" class="metric-value info">- ms</div>
                        <div class="metric-label">Latency</div>
                    </div>
                    <div class="metric">
                        <div id="uptime-value" class="metric-value info">-</div>
                        <div class="metric-label">Uptime</div>
                    </div>
                </div>
            </div>

            <!-- Data Availability -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon data">
                        <i class="fas fa-table"></i>
                    </div>
                    <div>
                        <div class="card-title">Data Availability</div>
                        <div class="card-subtitle">Table accessibility and row counts</div>
                    </div>
                </div>
                <div id="data-status" class="status-indicator status-loading">
                    <i class="fas fa-sync-alt spin"></i>
                    <span>Checking tables...</span>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Tables Accessible</span>
                        <span id="tables-score">0/3</span>
                    </div>
                    <div class="progress-bar">
                        <div id="tables-progress" class="progress-fill progress-info" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric">
                        <div id="guru-count" class="metric-value info">0</div>
                        <div class="metric-label">Data Guru</div>
                    </div>
                    <div class="metric">
                        <div id="ujian-count" class="metric-value info">0</div>
                        <div class="metric-label">Ujian</div>
                    </div>
                    <div class="metric">
                        <div id="soal-count" class="metric-value info">0</div>
                        <div class="metric-label">Bank Soal</div>
                    </div>
                </div>
            </div>

            <!-- Performance -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon performance">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div>
                        <div class="card-title">Performance</div>
                        <div class="card-subtitle">Response times and throughput</div>
                    </div>
                </div>
                <div id="performance-status" class="status-indicator status-loading">
                    <i class="fas fa-sync-alt spin"></i>
                    <span>Measuring performance...</span>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Response Time Score</span>
                        <span id="response-score">0ms</span>
                    </div>
                    <div class="progress-bar">
                        <div id="response-progress" class="progress-fill progress-info" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric">
                        <div id="avg-response" class="metric-value info">- ms</div>
                        <div class="metric-label">Avg Response</div>
                    </div>
                    <div class="metric">
                        <div id="requests-count" class="metric-value info">0</div>
                        <div class="metric-label">Requests</div>
                    </div>
                    <div class="metric">
                        <div id="cache-hit" class="metric-value info">0%</div>
                        <div class="metric-label">Cache Hit</div>
                    </div>
                </div>
            </div>

            <!-- Security & Configuration -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon security">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div>
                        <div class="card-title">Security & Config</div>
                        <div class="card-subtitle">CORS, Rate Limiting, Token Safety</div>
                    </div>
                </div>
                <div id="security-status" class="status-indicator status-loading">
                    <i class="fas fa-sync-alt spin"></i>
                    <span>Checking security...</span>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Security Score</span>
                        <span id="security-score">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="security-progress" class="progress-fill progress-info" style="width: 0%"></div>
                    </div>
                </div>
                <div id="security-checks">
                    <div class="log-entry log-info skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                    <div class="log-entry log-info skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                    <div class="log-entry log-info skeleton" style="height: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" onclick="runFullCheck()" id="run-check-btn">
                <i class="fas fa-play"></i> Run Full Diagnostic
            </button>
            <button class="btn btn-secondary" onclick="exportReport()" id="export-btn">
                <i class="fas fa-download"></i> Export Report
            </button>
            <button class="btn btn-secondary" onclick="refreshCheck()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Details Panel -->
        <div class="details-panel">
            <div class="details-header">
                <div class="details-title">
                    <i class="fas fa-list-alt"></i> Detailed Diagnostics Log
                </div>
                <div id="overall-status" class="status-indicator status-loading">
                    <i class="fas fa-sync-alt spin"></i>
                    <span>System Check in Progress</span>
                </div>
            </div>
            <div id="diagnostics-log">
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle"></i> Initializing Database Readiness Checker...
                </div>
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle"></i> Target: nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev
                </div>
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle"></i> Starting comprehensive health check...
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>
                <i class="fas fa-code"></i> Database Readiness Checker ‚Ä¢ 
                <strong>SMAN 2 Cikarang Barat</strong> ‚Ä¢ 
                <span id="current-year">2024</span>
            </p>
            <p class="mt-2">
                <i class="fas fa-shield-alt"></i> Token securely stored in Cloudflare Worker Environment Variables
            </p>
        </footer>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const WORKER_URL = 'https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev';
        const TABLES_TO_CHECK = ['data', 'ujian', 'bank_soal'];
        
        // Performance thresholds (in milliseconds)
        const THRESHOLDS = {
            excellent: 200,   // < 200ms = excellent
            good: 500,        // < 500ms = good
            warning: 1000,    // < 1000ms = warning
            error: 2000       // > 2000ms = error
        };
        
        // ================= STATE MANAGEMENT =================
        let checkResults = {
            connection: { status: 'loading', score: 0, details: [] },
            data: { status: 'loading', score: 0, tables: {}, details: [] },
            performance: { status: 'loading', score: 0, metrics: {}, details: [] },
            security: { status: 'loading', score: 0, checks: [], details: [] }
        };
        
        let diagnosticsLog = [];
        
        // ================= UI HELPER FUNCTIONS =================
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const icon = element.querySelector('i');
            const text = element.querySelector('span');
            
            element.className = `status-indicator status-${status}`;
            
            switch(status) {
                case 'ready':
                    icon.className = 'fas fa-check-circle';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle';
                    break;
                case 'error':
                    icon.className = 'fas fa-times-circle';
                    break;
                case 'loading':
                    icon.className = 'fas fa-sync-alt spin';
                    break;
            }
            
            if (text) text.textContent = message;
        }
        
        function updateProgress(progressId, scoreId, percentage, value) {
            const progress = document.getElementById(progressId);
            const score = document.getElementById(scoreId);
            
            if (progress) {
                progress.style.width = `${percentage}%`;
                
                // Update color based on percentage
                if (percentage >= 80) progress.className = 'progress-fill progress-success';
                else if (percentage >= 60) progress.className = 'progress-fill progress-warning';
                else progress.className = 'progress-fill progress-error';
            }
            
            if (score) score.textContent = value;
        }
        
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('diagnostics-log');
            const timestamp = new Date().toLocaleTimeString('id-ID', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const icons = {
                info: 'fa-info-circle',
                success: 'fa-check-circle',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                [${timestamp}] ${message}
            `;
            
            // Add to beginning for reverse chronological order
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 20 entries
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 20) {
                entries[entries.length - 1].remove();
            }
            
            // Add to memory log
            diagnosticsLog.push({
                timestamp: new Date().toISOString(),
                type,
                message
            });
        }
        
        // ================= CHECK FUNCTIONS =================
        
        async function checkWorkerConnection() {
            addLog('Testing Cloudflare Worker connection...', 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${WORKER_URL}/status`, {
                    signal: AbortSignal.timeout(5000)
                });
                const endTime = Date.now();
                const latency = endTime - startTime;
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Update UI
                document.getElementById('latency-value').textContent = `${latency} ms`;
                document.getElementById('uptime-value').textContent = 'Online';
                document.getElementById('latency-value').className = 
                    latency < THRESHOLDS.excellent ? 'metric-value success' :
                    latency < THRESHOLDS.good ? 'metric-value info' :
                    latency < THRESHOLDS.warning ? 'metric-value warning' : 'metric-value danger';
                
                // Calculate connection score
                let connectionScore = 100;
                if (latency > THRESHOLDS.error) connectionScore = 40;
                else if (latency > THRESHOLDS.warning) connectionScore = 60;
                else if (latency > THRESHOLDS.good) connectionScore = 80;
                
                updateProgress('worker-progress', 'worker-score', connectionScore, `${connectionScore}%`);
                updateStatus('connection-status', 'ready', `Connected (${latency}ms)`);
                
                addLog(`‚úÖ Worker connected successfully! Latency: ${latency}ms`, 'success');
                
                return {
                    status: 'ready',
                    latency,
                    data,
                    score: connectionScore
                };
                
            } catch (error) {
                addLog(`‚ùå Worker connection failed: ${error.message}`, 'error');
                updateStatus('connection-status', 'error', 'Connection Failed');
                updateProgress('worker-progress', 'worker-score', 0, '0%');
                document.getElementById('latency-value').textContent = 'Error';
                document.getElementById('latency-value').className = 'metric-value danger';
                
                return {
                    status: 'error',
                    error: error.message,
                    score: 0
                };
            }
        }
        
        async function checkNocoDBAPI() {
            addLog('Testing NocoDB API connection through Worker...', 'info');
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${WORKER_URL}/data?limit=1`, {
                    signal: AbortSignal.timeout(10000)
                });
                const endTime = Date.now();
                const latency = endTime - startTime;
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Calculate API score
                let apiScore = 100;
                if (latency > THRESHOLDS.error) apiScore = 40;
                else if (latency > THRESHOLDS.warning) apiScore = 60;
                else if (latency > THRESHOLDS.good) apiScore = 80;
                
                updateProgress('api-progress', 'api-score', apiScore, `${apiScore}%`);
                
                addLog(`‚úÖ NocoDB API accessible through Worker! Latency: ${latency}ms`, 'success');
                
                return {
                    status: 'ready',
                    latency,
                    data,
                    score: apiScore
                };
                
            } catch (error) {
                addLog(`‚ùå NocoDB API access failed: ${error.message}`, 'error');
                updateProgress('api-progress', 'api-score', 0, '0%');
                
                return {
                    status: 'error',
                    error: error.message,
                    score: 0
                };
            }
        }
        
        async function checkTableAccessibility() {
            addLog('Checking table accessibility...', 'info');
            
            const results = {};
            let accessibleTables = 0;
            let totalRows = 0;
            
            for (const table of TABLES_TO_CHECK) {
                try {
                    addLog(`Checking table: ${table}...`, 'info');
                    
                    const response = await fetch(`${WORKER_URL}/${table}?limit=1`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    const rowCount = data.list ? data.list.length : 0;
                    
                    results[table] = {
                        accessible: true,
                        rowCount,
                        sampleData: data.list ? data.list[0] : null
                    };
                    
                    accessibleTables++;
                    totalRows += rowCount;
                    
                    // Update specific table count
                    if (table === 'data') {
                        document.getElementById('guru-count').textContent = rowCount;
                        document.getElementById('guru-count').className = 
                            rowCount > 0 ? 'metric-value success' : 'metric-value warning';
                    } else if (table === 'ujian') {
                        document.getElementById('ujian-count').textContent = rowCount;
                        document.getElementById('ujian-count').className = 
                            rowCount > 0 ? 'metric-value success' : 'metric-value warning';
                    } else if (table === 'bank_soal') {
                        document.getElementById('soal-count').textContent = rowCount;
                        document.getElementById('soal-count').className = 
                            rowCount > 0 ? 'metric-value success' : 'metric-value warning';
                    }
                    
                    addLog(`‚úÖ Table "${table}" accessible (${rowCount} rows)`, 'success');
                    
                } catch (error) {
                    results[table] = {
                        accessible: false,
                        error: error.message
                    };
                    
                    addLog(`‚ùå Table "${table}" inaccessible: ${error.message}`, 'error');
                }
            }
            
            // Calculate data score
            const dataScore = Math.round((accessibleTables / TABLES_TO_CHECK.length) * 100);
            updateProgress('tables-progress', 'tables-score', dataScore, `${accessibleTables}/${TABLES_TO_CHECK.length}`);
            
            if (accessibleTables === TABLES_TO_CHECK.length) {
                updateStatus('data-status', 'ready', `All tables accessible`);
            } else if (accessibleTables > 0) {
                updateStatus('data-status', 'warning', `${accessibleTables}/${TABLES_TO_CHECK.length} tables accessible`);
            } else {
                updateStatus('data-status', 'error', 'No tables accessible');
            }
            
            return {
                status: accessibleTables === TABLES_TO_CHECK.length ? 'ready' : 
                       accessibleTables > 0 ? 'warning' : 'error',
                tables: results,
                accessibleTables,
                totalTables: TABLES_TO_CHECK.length,
                totalRows,
                score: dataScore
            };
        }
        
        async function checkPerformance() {
            addLog('Running performance tests...', 'info');
            
            const metrics = {
                responseTimes: [],
                successfulRequests: 0,
                totalRequests: 0,
                startTime: Date.now()
            };
            
            // Test multiple endpoints
            const endpoints = ['/data', '/ujian', '/bank_soal', '/tables', '/status'];
            
            for (const endpoint of endpoints) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(`${WORKER_URL}${endpoint}`);
                    const endTime = Date.now();
                    const latency = endTime - startTime;
                    
                    metrics.responseTimes.push(latency);
                    metrics.totalRequests++;
                    
                    if (response.ok) {
                        metrics.successfulRequests++;
                        addLog(`‚úÖ ${endpoint}: ${latency}ms`, 'success');
                    } else {
                        addLog(`‚ö†Ô∏è ${endpoint}: ${latency}ms (HTTP ${response.status})`, 'warning');
                    }
                    
                } catch (error) {
                    metrics.totalRequests++;
                    addLog(`‚ùå ${endpoint}: Failed - ${error.message}`, 'error');
                }
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // Calculate metrics
            const avgResponse = metrics.responseTimes.length > 0 
                ? Math.round(metrics.responseTimes.reduce((a, b) => a + b) / metrics.responseTimes.length)
                : 0;
            
            const successRate = metrics.totalRequests > 0
                ? Math.round((metrics.successfulRequests / metrics.totalRequests) * 100)
                : 0;
            
            // Update UI
            document.getElementById('avg-response').textContent = `${avgResponse} ms`;
            document.getElementById('avg-response').className = 
                avgResponse < THRESHOLDS.excellent ? 'metric-value success' :
                avgResponse < THRESHOLDS.good ? 'metric-value info' :
                avgResponse < THRESHOLDS.warning ? 'metric-value warning' : 'metric-value danger';
            
            document.getElementById('requests-count').textContent = metrics.totalRequests;
            document.getElementById('cache-hit').textContent = `${successRate}%`;
            document.getElementById('cache-hit').className = 
                successRate >= 90 ? 'metric-value success' :
                successRate >= 70 ? 'metric-value warning' : 'metric-value danger';
            
            // Calculate performance score
            let performanceScore = 0;
            if (avgResponse > 0) {
                const responseScore = avgResponse < THRESHOLDS.excellent ? 100 :
                                    avgResponse < THRESHOLDS.good ? 80 :
                                    avgResponse < THRESHOLDS.warning ? 60 : 40;
                
                const successScore = successRate;
                performanceScore = Math.round((responseScore * 0.7) + (successScore * 0.3));
            }
            
            updateProgress('response-progress', 'response-score', performanceScore, `${avgResponse}ms`);
            
            if (performanceScore >= 80) {
                updateStatus('performance-status', 'ready', `Excellent (${avgResponse}ms avg)`);
            } else if (performanceScore >= 60) {
                updateStatus('performance-status', 'warning', `Acceptable (${avgResponse}ms avg)`);
            } else {
                updateStatus('performance-status', 'error', `Poor (${avgResponse}ms avg)`);
            }
            
            addLog(`Performance test complete: ${avgResponse}ms avg, ${successRate}% success rate`, 'success');
            
            return {
                status: performanceScore >= 80 ? 'ready' : performanceScore >= 60 ? 'warning' : 'error',
                metrics,
                avgResponse,
                successRate,
                score: performanceScore
            };
        }
        
        async function checkSecurity() {
            addLog('Running security checks...', 'info');
            
            const checks = [];
            let securityScore = 0;
            
            // Clear skeleton
            document.getElementById('security-checks').innerHTML = '';
            
            // Check 1: CORS headers
            try {
                const response = await fetch(`${WORKER_URL}/status`);
                const corsHeader = response.headers.get('access-control-allow-origin');
                
                const check = {
                    name: 'CORS Configuration',
                    status: corsHeader ? 'pass' : 'fail',
                    message: corsHeader ? `CORS configured: ${corsHeader}` : 'CORS not configured'
                };
                
                checks.push(check);
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${check.status === 'pass' ? 'log-success' : 'log-error'}`;
                logEntry.innerHTML = `<i class="fas fa-${check.status === 'pass' ? 'check' : 'times'}-circle"></i> ${check.message}`;
                document.getElementById('security-checks').appendChild(logEntry);
                
                if (check.status === 'pass') securityScore += 25;
                addLog(`CORS check: ${check.status === 'pass' ? '‚úÖ' : '‚ùå'} ${check.message}`, check.status === 'pass' ? 'success' : 'error');
                
            } catch (error) {
                addLog(`CORS check failed: ${error.message}`, 'error');
            }
            
            // Check 2: Rate limiting headers
            try {
                const response = await fetch(`${WORKER_URL}/status`);
                const rateLimitHeader = response.headers.get('x-ratelimit-limit') || 
                                      response.headers.get('ratelimit-limit');
                
                const check = {
                    name: 'Rate Limiting',
                    status: rateLimitHeader ? 'pass' : 'warning',
                    message: rateLimitHeader ? `Rate limit configured: ${rateLimitHeader}` : 'Rate limiting not detected'
                };
                
                checks.push(check);
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${check.status === 'pass' ? 'log-success' : 'log-warning'}`;
                logEntry.innerHTML = `<i class="fas fa-${check.status === 'pass' ? 'check' : 'exclamation'}-circle"></i> ${check.message}`;
                document.getElementById('security-checks').appendChild(logEntry);
                
                if (check.status === 'pass') securityScore += 25;
                addLog(`Rate limiting check: ${check.status === 'pass' ? '‚úÖ' : '‚ö†Ô∏è'} ${check.message}`, check.status === 'pass' ? 'success' : 'warning');
                
            } catch (error) {
                addLog(`Rate limiting check failed: ${error.message}`, 'error');
            }
            
            // Check 3: Secure headers
            try {
                const response = await fetch(`${WORKER_URL}/status`);
                const securityHeaders = [
                    'x-content-type-options',
                    'x-frame-options',
                    'x-xss-protection'
                ];
                
                const missingHeaders = securityHeaders.filter(h => !response.headers.get(h));
                
                const check = {
                    name: 'Security Headers',
                    status: missingHeaders.length === 0 ? 'pass' : 'warning',
                    message: missingHeaders.length === 0 ? 
                        'All security headers present' : 
                        `Missing headers: ${missingHeaders.join(', ')}`
                };
                
                checks.push(check);
                
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${check.status === 'pass' ? 'log-success' : 'log-warning'}`;
                logEntry.innerHTML = `<i class="fas fa-${check.status === 'pass' ? 'check' : 'exclamation'}-circle"></i> ${check.message}`;
                document.getElementById('security-checks').appendChild(logEntry);
                
                if (check.status === 'pass') securityScore += 25;
                addLog(`Security headers check: ${check.status === 'pass' ? '‚úÖ' : '‚ö†Ô∏è'} ${check.message}`, check.status === 'pass' ? 'success' : 'warning');
                
            } catch (error) {
                addLog(`Security headers check failed: ${error.message}`, 'error');
            }
            
            // Check 4: Token safety (simulated)
            const check = {
                name: 'Token Security',
                status: 'pass',
                message: 'Token securely stored in Cloudflare Worker Environment Variables'
            };
            
            checks.push(check);
            securityScore += 25;
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry log-success';
            logEntry.innerHTML = `<i class="fas fa-check-circle"></i> ${check.message}`;
            document.getElementById('security-checks').appendChild(logEntry);
            
            addLog('Token security check: ‚úÖ Token safely stored in environment variables', 'success');
            
            // Update UI
            updateProgress('security-progress', 'security-score', securityScore, `${securityScore}%`);
            
            if (securityScore === 100) {
                updateStatus('security-status', 'ready', 'All security checks passed');
            } else if (securityScore >= 75) {
                updateStatus('security-status', 'warning', 'Security checks mostly passed');
            } else {
                updateStatus('security-status', 'error', 'Security checks failed');
            }
            
            return {
                status: securityScore === 100 ? 'ready' : securityScore >= 75 ? 'warning' : 'error',
                checks,
                score: securityScore
            };
        }
        
        // ================= MAIN CHECK FUNCTION =================
        async function runFullCheck() {
            // Disable button
            const btn = document.getElementById('run-check-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-sync-alt spin"></i> Running Diagnostics...';
            btn.disabled = true;
            
            // Reset overall status
            updateStatus('overall-status', 'loading', 'System Check in Progress');
            addLog('=== Starting comprehensive database readiness check ===', 'info');
            
            try {
                // Run all checks in sequence
                checkResults.connection = await checkWorkerConnection();
                checkResults.connection = {
                    ...checkResults.connection,
                    ...await checkNocoDBAPI()
                };
                
                checkResults.data = await checkTableAccessibility();
                checkResults.performance = await checkPerformance();
                checkResults.security = await checkSecurity();
                
                // Calculate overall score
                const overallScore = Math.round(
                    (checkResults.connection.score * 0.3) +
                    (checkResults.data.score * 0.3) +
                    (checkResults.performance.score * 0.25) +
                    (checkResults.security.score * 0.15)
                );
                
                // Determine overall status
                let overallStatus = 'ready';
                let overallMessage = 'System Ready';
                
                if (overallScore >= 90) {
                    overallStatus = 'ready';
                    overallMessage = 'Excellent - System Fully Operational';
                } else if (overallScore >= 70) {
                    overallStatus = 'warning';
                    overallMessage = 'Good - Minor Issues Detected';
                } else if (overallScore >= 50) {
                    overallStatus = 'warning';
                    overallMessage = 'Fair - Needs Attention';
                } else {
                    overallStatus = 'error';
                    overallMessage = 'Poor - Immediate Action Required';
                }
                
                // Update overall status
                updateStatus('overall-status', overallStatus, overallMessage);
                addLog(`=== Check complete! Overall score: ${overallScore}% - ${overallMessage} ===`, 
                      overallStatus === 'ready' ? 'success' : overallStatus === 'warning' ? 'warning' : 'error');
                
                // Enable export button
                document.getElementById('export-btn').disabled = false;
                
            } catch (error) {
                addLog(`‚ùå Fatal error during check: ${error.message}`, 'error');
                updateStatus('overall-status', 'error', 'Check Failed');
            } finally {
                // Re-enable button
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // ================= UTILITY FUNCTIONS =================
        function refreshCheck() {
            // Clear logs
            document.getElementById('diagnostics-log').innerHTML = `
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle"></i> Refreshing diagnostics...
                </div>
            `;
            
            diagnosticsLog = [];
            
            // Reset all status indicators
            updateStatus('connection-status', 'loading', 'Testing connections...');
            updateStatus('data-status', 'loading', 'Checking tables...');
            updateStatus('performance-status', 'loading', 'Measuring performance...');
            updateStatus('security-status', 'loading', 'Checking security...');
            updateStatus('overall-status', 'loading', 'System Check in Progress');
            
            // Reset progress bars
            updateProgress('worker-progress', 'worker-score', 0, '0%');
            updateProgress('api-progress', 'api-score', 0, '0%');
            updateProgress('tables-progress', 'tables-score', 0, '0/3');
            updateProgress('response-progress', 'response-score', 0, '0ms');
            updateProgress('security-progress', 'security-score', 0, '0%');
            
            // Reset metrics
            document.getElementById('latency-value').textContent = '- ms';
            document.getElementById('latency-value').className = 'metric-value info';
            document.getElementById('uptime-value').textContent = '-';
            document.getElementById('guru-count').textContent = '0';
            document.getElementById('guru-count').className = 'metric-value info';
            document.getElementById('ujian-count').textContent = '0';
            document.getElementById('ujian-count').className = 'metric-value info';
            document.getElementById('soal-count').textContent = '0';
            document.getElementById('soal-count').className = 'metric-value info';
            document.getElementById('avg-response').textContent = '- ms';
            document.getElementById('avg-response').className = 'metric-value info';
            document.getElementById('requests-count').textContent = '0';
            document.getElementById('cache-hit').textContent = '0%';
            document.getElementById('cache-hit').className = 'metric-value info';
            
            // Reset security checks skeleton
            document.getElementById('security-checks').innerHTML = `
                <div class="log-entry log-info skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                <div class="log-entry log-info skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                <div class="log-entry log-info skeleton" style="height: 20px;"></div>
            `;
            
            // Run check
            setTimeout(runFullCheck, 500);
        }
        
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                workerUrl: WORKER_URL,
                checkResults,
                diagnosticsLog,
                summary: {
                    connectionScore: checkResults.connection.score,
                    dataScore: checkResults.data.score,
                    performanceScore: checkResults.performance.score,
                    securityScore: checkResults.security.score,
                    overallScore: Math.round(
                        (checkResults.connection.score * 0.3) +
                        (checkResults.data.score * 0.3) +
                        (checkResults.performance.score * 0.25) +
                        (checkResults.security.score * 0.15)
                    )
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `database-readiness-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLog('Report exported successfully', 'success');
        }
        
        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', function() {
            // Set current year
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Auto-run check after 1 second
            setTimeout(runFullCheck, 1000);
        });
    </script>
</body>
</html>
