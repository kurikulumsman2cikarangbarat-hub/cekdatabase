<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏è Database Readiness Checker - SMAN 2 Cikarang Barat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS tetap sama seperti sebelumnya */
        :root { --primary: #2563eb; --success: #10b981; /* ... */ }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); }
        /* ... seluruh CSS yang sudah ada ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-database"></i> Database Readiness Checker</h1>
            <p>Comprehensive health check for NocoDB database and Cloudflare Worker</p>
            <div class="worker-url">
                <i class="fas fa-server"></i>
                Worker: nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev
            </div>
        </header>

        <!-- Status Cards Grid -->
        <div class="status-cards">
            <!-- Card 1: Connection Status -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon connection"><i class="fas fa-plug"></i></div>
                    <div>
                        <div class="card-title">Connection Status</div>
                        <div class="card-subtitle">Cloudflare Worker & NocoDB API</div>
                    </div>
                </div>
                <div id="connection-status" class="status-indicator status-loading">
                    <i class="fas fa-sync-alt spin"></i>
                    <span>Testing connections...</span>
                </div>
                <!-- ... konten card lainnya ... -->
            </div>
            
            <!-- Card 2-4 sama seperti sebelumnya -->
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" onclick="runFullCheck()" id="run-check-btn">
                <i class="fas fa-play"></i> Run Full Diagnostic
            </button>
            <button class="btn btn-secondary" onclick="exportReport()" id="export-btn">
                <i class="fas fa-download"></i> Export Report
            </button>
            <button class="btn btn-secondary" onclick="refreshCheck()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Details Panel -->
        <div class="details-panel">
            <div class="details-header">
                <div class="details-title"><i class="fas fa-list-alt"></i> Detailed Diagnostics Log</div>
                <div id="overall-status" class="status-indicator status-loading">
                    <i class="fas fa-sync-alt spin"></i>
                    <span>System Check in Progress</span>
                </div>
            </div>
            <div id="diagnostics-log">
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle"></i> Initializing Database Readiness Checker...
                </div>
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle"></i> Target: nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p><i class="fas fa-code"></i> Database Readiness Checker ‚Ä¢ <strong>SMAN 2 Cikarang Barat</strong></p>
        </footer>
    </div>

    <!-- üöÄ JavaScript Tanpa Export Statement -->
    <script>
        // ================= CONFIGURATION =================
        const WORKER_URL = 'https://nocob-proxy.kurikulum-sman2cikarangbarat.workers.dev';
        
        // State management (tanpa export!)
        let checkResults = {
            connection: { status: 'loading', score: 0 },
            data: { status: 'loading', score: 0 },
            performance: { status: 'loading', score: 0 },
            security: { status: 'loading', score: 0 }
        };

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            setTimeout(runFullCheck, 1000);
        });

        // ================= CHECK FUNCTIONS =================
        async function checkWorkerConnection() {
            try {
                const startTime = Date.now();
                const response = await fetch(`${WORKER_URL}/status`);
                const latency = Date.now() - startTime;
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                updateUI('connection', 'ready', latency);
                addLog(`‚úÖ Worker connected (${latency}ms)`, 'success');
                
                return { status: 'ready', latency, score: 100 };
            } catch (error) {
                updateUI('connection', 'error', 0);
                addLog(`‚ùå Worker connection failed: ${error.message}`, 'error');
                return { status: 'error', score: 0 };
            }
        }

        async function checkNocoDBAPI() {
            try {
                const response = await fetch(`${WORKER_URL}/data?limit=1`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                addLog('‚úÖ NocoDB API accessible', 'success');
                return { status: 'ready', score: 100 };
            } catch (error) {
                addLog(`‚ùå NocoDB API failed: ${error.message}`, 'error');
                return { status: 'error', score: 0 };
            }
        }

        // ================= UI FUNCTIONS =================
        function updateUI(section, status, value) {
            const element = document.getElementById(`${section}-status`);
            if (!element) return;
            
            const icon = element.querySelector('i');
            const text = element.querySelector('span');
            
            element.className = `status-indicator status-${status}`;
            icon.className = status === 'ready' ? 'fas fa-check-circle' :
                           status === 'error' ? 'fas fa-times-circle' :
                           'fas fa-sync-alt spin';
            
            if (text) {
                text.textContent = status === 'ready' ? `Connected (${value}ms)` :
                                 status === 'error' ? 'Connection Failed' :
                                 'Testing...';
            }
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('diagnostics-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : 
                                  type === 'error' ? 'times' : 'info'}-circle"></i>
                [${timestamp}] ${message}
            `;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
        }

        // ================= MAIN FUNCTION =================
        async function runFullCheck() {
            const btn = document.getElementById('run-check-btn');
            btn.innerHTML = '<i class="fas fa-sync-alt spin"></i> Running...';
            btn.disabled = true;
            
            addLog('=== Starting check ===', 'info');
            
            try {
                const [workerResult, apiResult] = await Promise.all([
                    checkWorkerConnection(),
                    checkNocoDBAPI()
                ]);
                
                // Update overall status
                const overallStatus = workerResult.status === 'ready' && apiResult.status === 'ready' 
                    ? 'ready' : 'error';
                
                const overallElement = document.getElementById('overall-status');
                overallElement.className = `status-indicator status-${overallStatus}`;
                overallElement.querySelector('i').className = overallStatus === 'ready' 
                    ? 'fas fa-check-circle' : 'fas fa-times-circle';
                overallElement.querySelector('span').textContent = 
                    overallStatus === 'ready' ? 'System Ready' : 'Check Failed';
                
                addLog(`=== Check ${overallStatus === 'ready' ? 'passed' : 'failed'} ===`, 
                      overallStatus === 'ready' ? 'success' : 'error');
                
            } catch (error) {
                addLog(`‚ùå Check failed: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = '<i class="fas fa-play"></i> Run Full Diagnostic';
                btn.disabled = false;
            }
        }

        function refreshCheck() {
            document.getElementById('diagnostics-log').innerHTML = `
                <div class="log-entry log-info">
                    <i class="fas fa-info-circle"></i> Refreshing...
                </div>
            `;
            setTimeout(runFullCheck, 500);
        }

        function exportReport() {
            alert('Export feature would generate JSON report');
        }
    </script>
</body>
</html>
